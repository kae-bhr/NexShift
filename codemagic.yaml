workflows:
  # Workflow de test automatique
  test-workflow:
    name: Tests automatiques
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      - name: Installer les dÃ©pendances
        script: |
          flutter pub get

      - name: Analyser le code
        script: |
          flutter analyze

      - name: ExÃ©cuter tous les tests
        script: |
          # ExÃ©cuter tous les tests sauf ceux qui nÃ©cessitent l'Ã©mulateur Firebase
          flutter test --exclude-tags=emulator --coverage

      - name: VÃ©rifier la couverture de code
        script: |
          # Installer lcov si nÃ©cessaire (pour gÃ©nÃ©rer les rapports de couverture)
          if ! command -v lcov &> /dev/null; then
            echo "Installation de lcov..."
            if [[ "$OSTYPE" == "darwin"* ]]; then
              brew install lcov
            else
              sudo apt-get update && sudo apt-get install -y lcov
            fi
          fi

          # GÃ©nÃ©rer le rapport de couverture
          genhtml coverage/lcov.info -o coverage/html

          # Calculer le pourcentage de couverture
          COVERAGE=$(lcov --summary coverage/lcov.info | grep "lines" | awk '{print $2}' | sed 's/%//')
          echo "Couverture actuelle: $COVERAGE%"

          # VÃ©rifier si la couverture atteint le seuil (80%)
          THRESHOLD=80
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âš ï¸  AVERTISSEMENT: La couverture de code ($COVERAGE%) est infÃ©rieure au seuil requis ($THRESHOLD%)"
            # Note: On n'Ã©choue pas le build, juste un avertissement
          else
            echo "âœ… Couverture de code OK: $COVERAGE% >= $THRESHOLD%"
          fi

      - name: RÃ©sumÃ© des tests
        script: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DES TESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Tests exÃ©cutÃ©s avec succÃ¨s âœ…"
          echo ""
          echo "Fichiers de test:"
          echo "  â€¢ test/integration/replacement/partial_replacement_test.dart"
          echo "  â€¢ test/integration/replacement/conflict_test.dart"
          echo "  â€¢ test/integration/replacement/validation_test.dart"
          echo "  â€¢ test/integration/replacement/race_condition_test.dart"
          echo ""
          echo "Note: Les tests de l'Ã©mulateur Firebase nÃ©cessitent"
          echo "      une exÃ©cution locale avec Firebase Emulator"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    artifacts:
      - coverage/**/*

    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
          source: true

  # Workflow de build Android
  android-workflow:
    name: Build Android
    max_build_duration: 120
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      - name: Installer les dÃ©pendances
        script: |
          flutter pub get

      - name: ExÃ©cuter les tests
        script: |
          flutter test --exclude-tags=emulator

      - name: Build Android APK
        script: |
          flutter build apk --release

      - name: Build Android App Bundle
        script: |
          flutter build appbundle --release

    artifacts:
      - build/app/outputs/**/*.apk
      - build/app/outputs/**/*.aab
      - flutter_drive.log

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'master'
          include: true
          source: true
        - pattern: 'main'
          include: true
          source: true

  # Workflow de build iOS
  ios-workflow:
    name: Build iOS
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      - name: Installer les dÃ©pendances
        script: |
          flutter pub get
          cd ios && pod install

      - name: ExÃ©cuter les tests
        script: |
          flutter test --exclude-tags=emulator

      - name: Build iOS
        script: |
          flutter build ios --release --no-codesign

    artifacts:
      - build/ios/iphoneos/**/*.app
      - flutter_drive.log

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'master'
          include: true
          source: true
        - pattern: 'main'
          include: true
          source: true

  # Workflow de dÃ©veloppement rapide (tests uniquement)
  dev-tests:
    name: Tests rapides (dev)
    max_build_duration: 30
    environment:
      flutter: stable

    scripts:
      - name: Installer les dÃ©pendances
        script: |
          flutter pub get

      - name: Tests unitaires seulement
        script: |
          # ExÃ©cuter uniquement les tests d'intÃ©gration de remplacement
          flutter test test/integration/replacement/ --exclude-tags=emulator

    triggering:
      events:
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
          source: true
