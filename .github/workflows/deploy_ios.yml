name: Deploy iOS to App Store Connect

on:
  # DÃ©clenchement manuel depuis GitHub (fonctionne depuis n'importe quel PC)
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Notes de version pour TestFlight'
        required: false
        default: 'Nouvelle version'

  # Ou automatiquement sur tag
  push:
    tags:
      - 'v*'

jobs:
  build-and-deploy:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_API_KEY" > ~/private_keys/AuthKey_$APP_STORE_CONNECT_KEY_ID.p8

      - name: Increment build number
        run: |
          cd ios
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          agvtool new-version -all $BUILD_NUMBER
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      - name: Build and upload with xcodebuild
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          cd ios

          # Build l'archive avec signing automatique via App Store Connect API
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Runner.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_$APP_STORE_CONNECT_KEY_ID.p8 \
            -authenticationKeyID $APP_STORE_CONNECT_KEY_ID \
            -authenticationKeyIssuerID $APP_STORE_CONNECT_ISSUER_ID \
            archive

          # Export l'IPA
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Runner.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_$APP_STORE_CONNECT_KEY_ID.p8 \
            -authenticationKeyID $APP_STORE_CONNECT_KEY_ID \
            -authenticationKeyIssuerID $APP_STORE_CONNECT_ISSUER_ID

      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file $RUNNER_TEMP/export/*.ipa \
            --apiKey "$APP_STORE_CONNECT_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"

      - name: Summary
        run: |
          echo "## iOS Build Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Build number: $BUILD_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- Le build est disponible dans TestFlight" >> $GITHUB_STEP_SUMMARY
