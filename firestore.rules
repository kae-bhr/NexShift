rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // RÈGLES POUR L'ARCHITECTURE MULTI-SDIS
    // À déployer sur nexshift-dev
    // ============================================

    // Helper function: Vérifie si l'utilisateur est authentifié
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function: Extrait le SDIS ID depuis l'email de l'utilisateur
    // Format email: {sdisId}_{matricule}@nexshift.app
    // Retourne le SDIS ou empty string si format invalide
    function getUserSDIS() {
      return isSignedIn() && request.auth.token.email != null
        ? request.auth.token.email.split('@')[0].split('_')[0]
        : '';
    }

    // Helper function: Extrait le matricule depuis l'email
    // Format email: {sdisId}_{matricule}@nexshift.app ou {matricule}@nexshift.app
    function getUserMatricule() {
      return isSignedIn() && request.auth.token.email != null
        ? (request.auth.token.email.split('@')[0].matches('.*_.*')
            ? request.auth.token.email.split('@')[0].split('_')[1]
            : request.auth.token.email.split('@')[0])
        : '';
    }

    // Helper function: Vérifie si l'utilisateur appartient au SDIS
    function belongsToSDIS(sdisId) {
      return isSignedIn() && getUserSDIS() == sdisId;
    }

    // Helper function: Vérifie si l'utilisateur appartient à la station
    // TEMPORAIRE: Permet l'accès sans custom claims
    function belongsToStation(sdisId, stationId) {
      return belongsToSDIS(sdisId);
      // TODO: Réactiver après configuration des custom claims:
      // return belongsToSDIS(sdisId) && request.auth.token.station == stationId;
    }

    // Helper function: Vérifie si l'utilisateur est admin
    // TEMPORAIRE: Permet l'accès admin sans custom claims
    function isAdmin() {
      return isSignedIn();
      // TODO: Réactiver après configuration des custom claims:
      // return isSignedIn() && request.auth.token.admin == true;
    }

    // Collection racine: sdis_list
    // Liste des SDIS disponibles dans l'application
    match /sdis_list/{sdisId} {
      // Lecture publique pour permettre la sélection du SDIS avant l'authentification
      allow read: if true;
      // Seuls les super-admins peuvent modifier (à implémenter plus tard)
      allow write: if false;
    }

    // Collection SDIS: /sdis/{sdisId}
    match /sdis/{sdisId} {
      // Lecture du document SDIS
      allow read: if belongsToSDIS(sdisId);
      allow write: if false; // Réservé aux super-admins

      // Sous-collection: user_stations
      match /user_stations/{userId} {
        // Un utilisateur peut lire ses propres stations
        allow read: if belongsToSDIS(sdisId) && getUserMatricule() == userId;
        // Seuls les admins peuvent modifier
        allow write: if belongsToSDIS(sdisId) && isAdmin();
      }

      // Sous-collection: stations
      // Permet de lister les stations pour la recherche multi-stations
      match /stations {
        allow list: if belongsToSDIS(sdisId);
      }

      match /stations/{stationId} {
        // Lecture du document station (config)
        allow read: if belongsToStation(sdisId, stationId);
        // Seuls les admins peuvent créer/modifier/supprimer la config
        allow create, update, delete: if belongsToStation(sdisId, stationId) && isAdmin();

        // Sous-collection: teams
        match /teams/{teamId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId) &&
                          (isAdmin() || request.auth.token.status == 'leader');
        }

        // Sous-collection: users
        match /users/{userId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Seuls les admins peuvent créer/supprimer des utilisateurs
          allow create, delete: if belongsToStation(sdisId, stationId) && isAdmin();
          // Les utilisateurs peuvent modifier leur propre profil ou les admins
          allow update: if belongsToStation(sdisId, stationId) &&
                           (getUserMatricule() == userId || isAdmin());
        }

        // Sous-collection: plannings
        match /plannings/{planningId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Seuls les admins et chefs peuvent modifier les plannings
          allow write: if belongsToStation(sdisId, stationId) &&
                          (isAdmin() || request.auth.token.status == 'leader');
        }

        // Sous-collection: trucks
        match /trucks/{truckId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Seuls les admins et chefs peuvent modifier les véhicules
          allow write: if belongsToStation(sdisId, stationId) &&
                          (isAdmin() || request.auth.token.status == 'leader');
        }

        // Sous-collection: shift_rules
        match /shift_rules/{ruleId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Seuls les admins peuvent modifier les règles d'astreintes
          allow write: if belongsToStation(sdisId, stationId) && isAdmin();
        }

        // Sous-collection: shift_exceptions
        match /shift_exceptions/{exceptionId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Admins et chefs peuvent créer des exceptions
          allow write: if belongsToStation(sdisId, stationId) &&
                          (isAdmin() || request.auth.token.status == 'leader');
        }

        // Sous-collection: availabilities
        match /availabilities/{availabilityId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Les utilisateurs peuvent gérer leurs propres disponibilités
          allow create, delete: if belongsToStation(sdisId, stationId) &&
                                    getUserMatricule() == resource.data.userId;
          allow update: if belongsToStation(sdisId, stationId) &&
                           (getUserMatricule() == resource.data.userId || isAdmin());
        }

        // Sous-collection: subshifts (remplacements)
        match /subshifts/{subshiftId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Les utilisateurs impliqués peuvent modifier leurs remplacements
          allow write: if belongsToStation(sdisId, stationId);
        }

        // Sous-collection: positions
        match /positions/{positionId} {
          allow read: if belongsToStation(sdisId, stationId);
          // Seuls les admins peuvent modifier les postes
          allow write: if belongsToStation(sdisId, stationId) && isAdmin();
        }

        // Sous-collection: replacementRequests
        match /replacementRequests/{requestId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId);
        }

        // Sous-collection: replacementRequestDeclines
        match /replacementRequestDeclines/{declineId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId);
        }

        // Sous-collection: manualReplacementAcceptances
        match /manualReplacementAcceptances/{acceptanceId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId);
        }

        // Sous-collection: manualReplacementProposals
        match /manualReplacementProposals/{proposalId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId);
        }

        // Sous-collection: notificationTriggers
        match /notificationTriggers/{triggerId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId) &&
                          (isAdmin() || request.auth.token.status == 'leader');
        }

        // Sous-collection: waveStateTriggers
        match /waveStateTriggers/{triggerId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId);
        }

        // Sous-collection: testNotifications
        match /testNotifications/{notificationId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId) && isAdmin();
        }

        // Sous-collection: vehicleRules
        match /vehicleRules/{ruleId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId) &&
                          (isAdmin() || request.auth.token.status == 'leader');
        }

        // Sous-collection: vehicle_rule_sets
        match /vehicle_rule_sets/{ruleSetId} {
          allow read: if belongsToStation(sdisId, stationId);
          allow write: if belongsToStation(sdisId, stationId) &&
                          (isAdmin() || request.auth.token.status == 'leader');
        }
      }

      // Sous-collection: user_notifications (au niveau SDIS)
      // Notifications pour tous les utilisateurs du SDIS
      match /user_notifications/{notificationId} {
        // Un utilisateur peut lire ses propres notifications
        allow read: if belongsToSDIS(sdisId) && resource.data.userId == getUserMatricule();
        // Seuls les admins peuvent créer des notifications
        allow create: if belongsToSDIS(sdisId) && isAdmin();
        // Un utilisateur peut marquer ses notifications comme lues
        allow update: if belongsToSDIS(sdisId) && resource.data.userId == getUserMatricule();
        // Seuls les admins peuvent supprimer
        allow delete: if belongsToSDIS(sdisId) && isAdmin();
      }
    }

    // Collection licences (racine) - Gestion multi-tenant
    match /licences/{licenceId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // LEGACY: Collection user_notifications (racine) - Notifications utilisateurs
    // Permet la rétrocompatibilité pendant la migration
    // À SUPPRIMER une fois la migration vers /sdis/{sdisId}/user_notifications terminée
    match /user_notifications/{notificationId} {
      // Un utilisateur peut lire ses propres notifications
      allow read: if isSignedIn() && resource.data.userId == getUserMatricule();
      // Seuls les admins peuvent créer des notifications
      allow create: if isSignedIn() && isAdmin();
      // Un utilisateur peut marquer ses notifications comme lues
      allow update: if isSignedIn() && resource.data.userId == getUserMatricule();
      // Seuls les admins peuvent supprimer
      allow delete: if isSignedIn() && isAdmin();
    }

    // LEGACY: Collection user_stations (racine) - Mapping utilisateur -> stations
    // Permet la rétrocompatibilité pendant la migration
    match /user_stations/{userId} {
      // TEMPORAIRE: Accès permissif pour la période de migration
      allow read, write: if isSignedIn();
    }

    // LEGACY: Collection stations (racine)
    // Permet la rétrocompatibilité pendant la migration
    match /stations/{stationId} {
      allow read, write: if isSignedIn();

      // Toutes les sous-collections de stations en mode legacy
      match /{subcollection}/{document=**} {
        allow read, write: if isSignedIn();
      }
    }

    // LEGACY: Collection plannings (racine) - Migration en cours
    // TEMPORAIRE: Accès permissif pendant la migration
    match /plannings/{planningId} {
      allow read, write: if isSignedIn();
    }

    // LEGACY: Collection users (racine) - Migration en cours
    // TEMPORAIRE: Accès permissif pendant la migration
    match /users/{userId} {
      allow read, write: if isSignedIn();
    }

    // LEGACY: Collection teams (racine) - Migration en cours
    // TEMPORAIRE: Accès permissif pendant la migration
    match /teams/{teamId} {
      allow read, write: if isSignedIn();
    }

    // LEGACY: Collection replacementRequests (racine) - Migration en cours
    // TEMPORAIRE: Accès permissif pendant la migration
    match /replacementRequests/{requestId} {
      allow read, write: if isSignedIn();
    }

    // LEGACY: Collection replacementRequestDeclines (racine) - Migration en cours
    // TEMPORAIRE: Accès permissif pendant la migration
    match /replacementRequestDeclines/{declineId} {
      allow read, write: if isSignedIn();
    }

    // LEGACY: Collection vehicle_rule_sets (racine) - Migration en cours
    // TEMPORAIRE: Accès permissif pendant la migration
    match /vehicle_rule_sets/{ruleSetId} {
      allow read, write: if isSignedIn();
    }

    // LEGACY: Autres collections racines legacy
    // TEMPORAIRE: Accès permissif pendant la migration
    match /{legacyCollection}/{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
