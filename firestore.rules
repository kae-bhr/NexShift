rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // RÈGLES POUR L'ARCHITECTURE MULTI-SDIS
    // Avec Custom Claims pour l'autorisation
    // ============================================

    // Helper function: Vérifie si l'utilisateur est authentifié
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function: Récupère le SDIS ID depuis les custom claims
    function getUserSDIS() {
      return isSignedIn() && request.auth.token.sdisId != null
        ? request.auth.token.sdisId
        : '';
    }

    // Helper function: Vérifie si l'utilisateur appartient au SDIS
    function belongsToSDIS(sdisId) {
      return isSignedIn() && getUserSDIS() == sdisId;
    }

    // Helper function: Vérifie si l'utilisateur a accès à la station
    function hasStationAccess(sdisId, stationId) {
      return belongsToSDIS(sdisId) &&
             request.auth.token.stations != null &&
             stationId in request.auth.token.stations;
    }

    // Helper function: Récupère le rôle de l'utilisateur dans une station
    function getStationRole(stationId) {
      return request.auth.token.stations != null && stationId in request.auth.token.stations
        ? request.auth.token.stations[stationId]
        : '';
    }

    // Helper function: Vérifie si l'utilisateur est admin de la station
    function isStationAdmin(sdisId, stationId) {
      return hasStationAccess(sdisId, stationId) && getStationRole(stationId) == 'admin';
    }

    // Helper function: Vérifie si l'utilisateur est leader ou supérieur dans la station
    function isStationLeaderOrAbove(sdisId, stationId) {
      let role = getStationRole(stationId);
      return hasStationAccess(sdisId, stationId) &&
             (role == 'leader' || role == 'chief' || role == 'admin');
    }

    // Helper function: Vérifie si l'utilisateur est admin d'au moins une station
    function isAnyStationAdmin() {
      return isSignedIn() &&
             request.auth.token.role == 'admin';
    }

    // Collection racine: app_config
    match /app_config/{docId} {
      allow read: if true;
      allow write: if isAnyStationAdmin();
    }

    // Collection racine: sdis_list
    match /sdis_list/{sdisId} {
      allow read: if true;
      allow write: if false; // Super-admin only
    }

    // ============================================
    // COLLECTION SDIS: /sdis/{sdisId}
    // ============================================
    match /sdis/{sdisId} {
      allow read: if belongsToSDIS(sdisId);
      allow write: if false; // Super-admin only

      // Sous-collection: users (profils globaux - PII chiffrées)
      // Ces documents sont gérés par les Cloud Functions
      match /users/{authUid} {
        // Lecture: soi-même ou admin
        allow read: if belongsToSDIS(sdisId) &&
                       (request.auth.uid == authUid || isAnyStationAdmin());
        // Écriture réservée aux Cloud Functions
        allow write: if false;
      }

      // Sous-collection: user_stations (mapping utilisateur -> stations)
      match /user_stations/{authUid} {
        allow read: if belongsToSDIS(sdisId) && request.auth.uid == authUid;
        allow write: if false; // Géré par Cloud Functions
      }

      // Index pré-enregistrement (lookup O(1) lors de la création de compte)
      match /pre_registered_matricules/{matricule} {
        allow read: if belongsToSDIS(sdisId);
        allow write: if false; // Géré par Cloud Functions uniquement
      }

      // Sous-collection: stations
      match /stations/{stationId} {
        // Lecture de la config station
        allow read: if hasStationAccess(sdisId, stationId) || belongsToSDIS(sdisId);
        // Modification: admin only
        allow create, update, delete: if isStationAdmin(sdisId, stationId);

        // Sous-collection: users (profils par station - PII chiffrées)
        match /users/{userId} {
          allow read: if hasStationAccess(sdisId, stationId);
          // Création/suppression: admin ou Cloud Functions
          allow create, delete: if isStationAdmin(sdisId, stationId);
          // Modification: soi-même ou admin
          allow update: if hasStationAccess(sdisId, stationId) &&
                           (resource.data.authUid == request.auth.uid ||
                            isStationAdmin(sdisId, stationId));
        }

        // Sous-collection: membership_requests (demandes d'adhésion)
        match /membership_requests/{requestId} {
          // Lecture: admin de la station ou l'utilisateur qui a fait la demande
          allow read: if isStationAdmin(sdisId, stationId) ||
                         (belongsToSDIS(sdisId) && request.auth.uid == requestId);
          // Écriture réservée aux Cloud Functions
          allow write: if false;
        }

        // Sous-collection: reserved_matricules (réservations)
        match /reserved_matricules/{matricule} {
          allow read: if isStationAdmin(sdisId, stationId);
          // Écriture réservée aux Cloud Functions
          allow write: if false;
        }

        // Sous-collection: teams
        match /teams/{teamId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationLeaderOrAbove(sdisId, stationId);
        }

        // Sous-collection: plannings
        match /plannings/{planningId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationLeaderOrAbove(sdisId, stationId);
        }

        // Sous-collection: trucks
        match /trucks/{truckId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationLeaderOrAbove(sdisId, stationId);
        }

        // Sous-collection: shift_rules
        match /shift_rules/{ruleId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationAdmin(sdisId, stationId);
        }

        // Sous-collection: shift_exceptions
        match /shift_exceptions/{exceptionId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationLeaderOrAbove(sdisId, stationId);
        }

        // Sous-collection: availabilities
        match /availabilities/{availabilityId} {
          allow read: if hasStationAccess(sdisId, stationId);
          // Création/suppression par le propriétaire
          allow create: if hasStationAccess(sdisId, stationId);
          allow delete: if hasStationAccess(sdisId, stationId) &&
                           resource.data.authUid == request.auth.uid;
          allow update: if hasStationAccess(sdisId, stationId) &&
                           (resource.data.authUid == request.auth.uid ||
                            isStationAdmin(sdisId, stationId));
        }

        // Sous-collection: subshifts (remplacements)
        match /subshifts/{subshiftId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        // Sous-collection: positions
        match /positions/{positionId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationAdmin(sdisId, stationId);
        }

        // Sous-collection: replacements
        match /replacements/{requestId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        match /replacements/all/subshifts/{subshiftId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        match /replacements/automatic/notificationTriggers/{triggerId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        match /replacements/automatic/waveStateTriggers/{triggerId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        // Sous-collection: replacementRequests (LEGACY)
        match /replacementRequests/{requestId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        // Sous-collection: replacementRequestDeclines
        match /replacementRequestDeclines/{declineId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        // Sous-collection: manualReplacementAcceptances
        match /manualReplacementAcceptances/{acceptanceId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        // Sous-collection: manualReplacementProposals
        match /manualReplacementProposals/{proposalId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        // Sous-collection: notificationTriggers
        match /notificationTriggers/{triggerId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationLeaderOrAbove(sdisId, stationId);
        }

        // Sous-collection: waveStateTriggers
        match /waveStateTriggers/{triggerId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if hasStationAccess(sdisId, stationId);
        }

        // Sous-collection: testNotifications
        match /testNotifications/{notificationId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationAdmin(sdisId, stationId);
        }

        // Sous-collection: vehicleRules
        match /vehicleRules/{ruleId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationLeaderOrAbove(sdisId, stationId);
        }

        // Sous-collection: vehicle_rule_sets
        match /vehicle_rule_sets/{ruleSetId} {
          allow read: if hasStationAccess(sdisId, stationId);
          allow write: if isStationLeaderOrAbove(sdisId, stationId);
        }
      }

      // Sous-collection: user_notifications (au niveau SDIS)
      match /user_notifications/{notificationId} {
        allow read: if belongsToSDIS(sdisId) &&
                       resource.data.authUid == request.auth.uid;
        allow create: if isAnyStationAdmin();
        allow update: if belongsToSDIS(sdisId) &&
                         resource.data.authUid == request.auth.uid;
        allow delete: if isAnyStationAdmin();
      }
    }

    // ============================================
    // COLLECTIONS LEGACY - Période de migration
    // ============================================

    // Collection auth (licences) - À SUPPRIMER après migration
    match /auth/{licenceId} {
      allow read: if true;
      allow write: if isAnyStationAdmin();
    }

    // Collection licences - À SUPPRIMER après migration
    match /licences/{licenceId} {
      allow read: if isSignedIn();
      allow write: if isAnyStationAdmin();
    }

    // LEGACY: Collections racines - Accès permissif pendant migration
    match /user_notifications/{notificationId} {
      allow read, write: if isSignedIn();
    }

    match /user_stations/{userId} {
      allow read, write: if isSignedIn();
    }

    match /stations/{stationId} {
      allow read, write: if isSignedIn();
      match /{subcollection}/{document=**} {
        allow read, write: if isSignedIn();
      }
    }

    match /plannings/{planningId} {
      allow read, write: if isSignedIn();
    }

    match /users/{userId} {
      allow read, write: if isSignedIn();
    }

    match /teams/{teamId} {
      allow read, write: if isSignedIn();
    }

    match /replacementRequests/{requestId} {
      allow read, write: if isSignedIn();
    }

    match /replacementRequestDeclines/{declineId} {
      allow read, write: if isSignedIn();
    }

    match /vehicle_rule_sets/{ruleSetId} {
      allow read, write: if isSignedIn();
    }

    // Catch-all pour autres collections legacy
    match /{legacyCollection}/{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
