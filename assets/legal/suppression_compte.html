<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NexShift - Suppression de compte</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #904A44;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .alert {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #856404;
    }

    .alert-warning {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }

    .alert-success {
      background-color: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .alert-error {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #904A44;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-danger {
      background-color: #dc3545;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background-color: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background-color: #5a6268;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #904A44;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      color: #666;
      font-size: 12px;
    }

    .hidden {
      display: none;
    }

    .checkbox-group {
      margin: 20px 0;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üóëÔ∏è Suppression de compte</h1>
      <p>NexShift - Gestion des astreintes</p>
    </div>

    <!-- Formulaire de connexion -->
    <div id="loginForm">
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Attention !</strong> Cette action est irr√©versible. Toutes vos donn√©es seront d√©finitivement
        supprim√©es.
      </div>

      <form id="deleteAccountForm">
        <div class="form-group">
          <label for="matricule">Matricule</label>
          <div style="position: relative;">
            <input type="text" id="matricule" name="matricule" placeholder="Votre matricule" required style="padding-right: 130px;" />
            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;">@nexshift.app</span>
          </div>
        </div>

        <div class="form-group">
          <label for="password">Mot de passe</label>
          <input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>

        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="confirmDelete" required />
            <span>Je comprends que cette action est irr√©versible et que toutes mes donn√©es seront supprim√©es</span>
          </label>
        </div>

        <button type="submit" class="btn btn-danger" id="deleteBtn">
          Supprimer d√©finitivement mon compte
        </button>

        <button type="button" class="btn btn-secondary" id="cancelBtn">
          Annuler
        </button>
      </form>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 10px; color: #666;">Suppression en cours...</p>
      </div>
    </div>

    <!-- Message de succ√®s -->
    <div id="successMessage" class="hidden">
      <div class="alert alert-success">
        <strong>‚úÖ Compte supprim√© avec succ√®s</strong>
        <p style="margin-top: 10px;">Votre compte et toutes vos donn√©es associ√©es ont √©t√© d√©finitivement supprim√©s.
        </p>
        <p style="margin-top: 10px;">Vous allez √™tre redirig√© dans quelques secondes...</p>
      </div>
    </div>

    <!-- Message d'erreur -->
    <div id="errorMessage" class="alert alert-error hidden">
      <strong>‚ùå Erreur</strong>
      <p id="errorText"></p>
    </div>

    <div class="footer">
      <p>¬© 2025 NexShift ‚Äì Tous droits r√©serv√©s</p>
      <p style="margin-top: 5px;">Pour toute question : bhr.holzer@gmail.com</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import {
      getAuth,
      signInWithEmailAndPassword,
      deleteUser,
      EmailAuthProvider,
      reauthenticateWithCredential
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Importer la configuration Firebase depuis un fichier externe
    import { firebaseConfig } from './firebase-config.js';

    // Initialiser Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // √âl√©ments du DOM
    const form = document.getElementById('deleteAccountForm');
    const loginFormDiv = document.getElementById('loginForm');
    const successMessageDiv = document.getElementById('successMessage');
    const errorMessageDiv = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const loading = document.getElementById('loading');
    const deleteBtn = document.getElementById('deleteBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // Fonction pour afficher les erreurs
    function showError(message) {
      errorText.textContent = message;
      errorMessageDiv.classList.remove('hidden');
      loading.classList.remove('active');
      deleteBtn.disabled = false;
    }

    // Fonction pour masquer les erreurs
    function hideError() {
      errorMessageDiv.classList.add('hidden');
    }

    // Bouton annuler
    cancelBtn.addEventListener('click', () => {
      if (confirm('√ätes-vous s√ªr de vouloir annuler ?')) {
        window.location.href = 'about:blank';
      }
    });

    // Gestion du formulaire
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const matricule = document.getElementById('matricule').value.trim();
      const password = document.getElementById('password').value;
      const confirmDelete = document.getElementById('confirmDelete').checked;

      if (!confirmDelete) {
        showError('Veuillez cocher la case de confirmation.');
        return;
      }

      // Construire l'email complet avec @nexshift.app
      const email = `${matricule}@nexshift.app`;

      // Confirmation finale
      const finalConfirm = confirm(
        `‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nVous √™tes sur le point de supprimer d√©finitivement votre compte : ${matricule}\n\nCette action est IRR√âVERSIBLE et entra√Ænera :\n- La suppression de votre compte\n- La perte de toutes vos donn√©es\n- La perte de vos plannings et disponibilit√©s\n\n√ätes-vous absolument certain de vouloir continuer ?`
      );

      if (!finalConfirm) {
        return;
      }

      // D√©sactiver le bouton et afficher le loading
      deleteBtn.disabled = true;
      loading.classList.add('active');

      try {
        console.log('üîê Tentative de connexion...');

        // 1. Se connecter avec l'email et le mot de passe
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        console.log('‚úÖ Connexion r√©ussie, UID:', user.uid);

        // 2. R√©-authentifier l'utilisateur (requis pour la suppression)
        const credential = EmailAuthProvider.credential(email, password);
        await reauthenticateWithCredential(user, credential);

        console.log('‚úÖ R√©-authentification r√©ussie');

        // 3. Supprimer le document utilisateur de Firestore (obligatoire)
        try {
          // IMPORTANT: Utiliser le matricule comme ID de document, PAS user.uid
          const userDocRef = doc(db, 'users', matricule);
          await deleteDoc(userDocRef);
          console.log('‚úÖ Document Firestore supprim√©:', matricule);
        } catch (firestoreError) {
          console.warn('‚ö†Ô∏è Erreur lors de la suppression Firestore (peut √™tre normal si le doc n\'existe pas):', firestoreError);
        }

        // 4. Supprimer le compte Authentication
        await deleteUser(user);

        console.log('‚úÖ Compte supprim√© avec succ√®s');

        // Afficher le message de succ√®s
        loginFormDiv.classList.add('hidden');
        successMessageDiv.classList.remove('hidden');
        loading.classList.remove('active');

        // Rediriger apr√®s 5 secondes
        setTimeout(() => {
          window.location.href = 'about:blank';
        }, 5000);

      } catch (error) {
        console.error('‚ùå Erreur lors de la suppression:', error);

        let errorMessage = 'Une erreur est survenue lors de la suppression du compte.';

        switch (error.code) {
          case 'auth/invalid-email':
            errorMessage = 'Adresse email invalide.';
            break;
          case 'auth/user-disabled':
            errorMessage = 'Ce compte a √©t√© d√©sactiv√©.';
            break;
          case 'auth/user-not-found':
            errorMessage = 'Aucun compte ne correspond √† cette adresse email.';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Mot de passe incorrect.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Trop de tentatives. Veuillez r√©essayer plus tard.';
            break;
          case 'auth/network-request-failed':
            errorMessage = 'Erreur r√©seau. V√©rifiez votre connexion Internet.';
            break;
          case 'auth/requires-recent-login':
            errorMessage = 'Pour des raisons de s√©curit√©, veuillez vous reconnecter puis r√©essayer.';
            break;
          default:
            errorMessage = `Erreur: ${error.message}`;
        }

        showError(errorMessage);
      }
    });

    console.log('üî• Firebase initialis√© et pr√™t');
  </script>
</body>

</html>